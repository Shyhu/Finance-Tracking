{% extends 'base.html' %}
{% load static %}
{% block content %}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center">
        <h2>Transactions</h2>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTransactionModal">+ Add Transaction</button>
    </div>

    <table class="table mt-3">
        <thead>
            <tr>
                <th>Date</th>
                <th>Project</th>
                <th>Description</th>
                <th>Category</th>
                <th>Amount</th>
                <th>Type</th>
                <th>Status</th>
                <th>Bill Proof</th>
                <th>Payment Proof</th>
            </tr>
        </thead>
        <tbody>
            {% for txn in transactions %}
                <tr>
                    <td>{{ txn.created_at|date:"Y-m-d" }}</td>
                    <td>{{ txn.project.name }}</td>
                    <td>{{ txn.description }}</td>
                    <td>{{ txn.category }}</td>
                    <td>{{ txn.amount }}</td>
                    <td>{{ txn.type }}</td>
                    <td>{{ txn.status }}</td>
                    <td>
                        {% for file in txn.bill_proofs.all %}
                            <a href="{{ file.file.url }}">{{ file.file.name }}</a><br>
                        {% endfor %}
                    </td>
                    <td>
                        {% for file in txn.payment_proofs.all %}
                            <a href="{{ file.file.url }}">{{ file.file.name }}</a><br>
                        {% endfor %}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal -->
<div class="modal fade" id="addTransactionModal" tabindex="-1" aria-labelledby="addTransactionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="transactionForm" enctype="multipart/form-data">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add New Transaction</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body row">
            {% csrf_token %}
            <div class="col-md-6 mb-3">
                <label>Transaction ID</label>
                <input type="text" name="transaction_id" class="form-control">
            </div>
            <div class="col-md-6 mb-3">
                <label>Project</label>
                <select name="project" class="form-select">
                    {% for project in projects %}
                        <option value="{{ project.id }}">{{ project.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6 mb-3">
                <label>Type</label>
                <select name="type" class="form-select">
                    <option value="Income">Income</option>
                    <option value="Expense">Expense</option>
                </select>
            </div>
            <div class="col-md-6 mb-3">
                <label>Amount</label>
                <input type="number" step="0.01" name="amount" class="form-control">
            </div>
            <div class="col-md-6 mb-3">
                <label>Vendor</label>
                <input type="text" name="vendor" class="form-control">
            </div>
            <div class="col-md-6 mb-3">
                <label>Status</label>
                <select name="status" class="form-select">
                    <option value="Approved">Approved</option>
                    <option value="Pending">Pending</option>
                    <option value="Rejected">Rejected</option>
                </select>
            </div>
            <div class="col-md-6 mb-3">
                <label>Category</label>
                <select name="category" class="form-select">
                    {% for cat in categories %}
                        <option value="{{ cat.name }}">{{ cat.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6 mb-3">
                <label>Description</label>
                <textarea name="description" class="form-control"></textarea>
            </div>
            <div class="col-md-6 mb-3">
                <label>Bill Proof(s)</label>
                <input type="file" name="bill_proofs" class="form-control" multiple>
            </div>
            <div class="col-md-6 mb-3">
                <label>Payment Proof(s)</label>
                <input type="file" name="payment_proofs" class="form-control" multiple>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-success">Save</button>
          </div>
        </div>
    </form>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $('#transactionForm').submit(function(e){
        e.preventDefault();
        let formData = new FormData(this);

        $.ajax({
            type: 'POST',
            url: '{% url "add_transaction" %}',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response){
                if(response.success){
                    location.reload();
                } else {
                    alert("Error saving transaction.");
                }
            }
        });
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

{% endblock %}
