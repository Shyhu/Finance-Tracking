{% extends 'base.html' %}
{% load static %}
{% block content %}
<style>
  .table th, .table td {
    vertical-align: middle;
  }
  .modal-title {
    font-weight: bold;
  }
  .btn-primary {
    background: linear-gradient(to right,rgb(79, 163, 232),rgb(46, 94, 139));
    border: none;
  }
  .btn-primary:hover {
    background: linear-gradient(to right, #2E8B57, #4CAF50);
  }
  .form-control, .form-select {
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease-in-out;
  }
  .form-control:focus, .form-select:focus {
    border-color: #4CAF50;
    box-shadow: 0 0 5px rgba(76, 175, 80, 0.6);
  }
  .fade-in {
    animation: fadeIn 0.6s ease-in-out both;
  }
  @keyframes fadeIn {
    0% {opacity: 0; transform: translateY(10px);}
    100% {opacity: 1; transform: translateY(0);}
  }
  .page-title {
        font-weight: 600;
        font-size: 2rem;
        color: #343a40;
        position: relative;
        padding-bottom: 10px;
    }

    .page-title::after {
        content: '';
        position: absolute;
        left: 0;
        bottom: 0;
        width: 60px;
        height: 4px;
        background: linear-gradient(90deg, #0d6efd, #6610f2);
        border-radius: 2px;
    }
      .custom-card {
    transition: transform 0.2s ease-in-out;
  }
  .custom-card:hover {
    transform: scale(1.02);
  }
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
   <h2 class="page-title mb-3 mb-md-0">
     <i class="bi bi-cash-coin me-2"></i> Loan Management
   </h2>
   <div>
     <a href="{% url 'download_loan_pdf' %}" class="btn btn-outline-secondary me-2">
         <i class="bi bi-file-earmark-pdf-fill me-1"></i> Download PDF
     </a>
     <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addLoanModal">
         + Add New Loan
     </button>
   </div>
</div>

{% comment %} Filter Section {% endcomment %}
<div class="card shadow-sm p-4 mb-4 fade-in">
  <form id="loanFilterForm" method="get">
    <div class="row g-3">
      <div class="col-md-3">
        <label class="form-label">Project</label>
        <select name="project" class="form-select live-filter">
          <option value="">All</option>
          {% for project in projects %}
          <option value="{{ project.id }}" {% if request.GET.project == project.id|stringformat:"s" %}selected{% endif %}>{{ project.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Loan Amount ≥</label>
        <input type="number" name="loan_amount" class="form-control live-filter" value="{{ request.GET.loan_amount }}">
      </div>
      <div class="col-md-2">
        <label class="form-label">Balance ≤</label>
        <input type="number" name="balance" class="form-control live-filter" value="{{ request.GET.balance }}">
      </div>
      <div class="col-md-2">
        <label class="form-label">Start Date</label>
        <input type="date" name="start_date" class="form-control live-filter" value="{{ request.GET.start_date }}">
      </div>
      <div class="col-md-2">
        <label class="form-label">Interest Rate</label>
        <input type="number" name="interest_rate" step="0.01" class="form-control live-filter" value="{{ request.GET.interest_rate }}">
      </div>
      <div class="col-md-1 d-flex align-items-end">
        <a href="{% url 'loan_list' %}" class="btn btn-outline-secondary w-100">Reset</a>
      </div>
    </div>
  </form>
</div>



<!-- Summary Cards -->
<div class="row g-3 mb-4">
  <div class="col-md-3">
    <div class="card shadow-sm p-3 border-start border-primary border-4 custom-card">
      <div class="d-flex align-items-center">
        <i class="fas fa-hand-holding-usd fa-2x text-primary me-3"></i>
        <div>
          <h6 class="mb-1">Total Loaned Amount</h6>
          <h4 class="text-primary fw-bold mb-0">₹{{ total_loaned_amount|floatformat:2 }}</h4>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card shadow-sm p-3 border-start border-success border-4 custom-card">
      <div class="d-flex align-items-center">
        <i class="fas fa-coins fa-2x text-success me-3"></i>
        <div>
          <h6 class="mb-1">Total Principal Repaid</h6>
          <h4 class="text-success fw-bold mb-0">₹{{ total_principal_repaid|floatformat:2 }}</h4>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card shadow-sm p-3 border-start border-warning border-4 custom-card">
      <div class="d-flex align-items-center">
        <i class="fas fa-percent fa-2x text-warning me-3"></i>
        <div>
          <h6 class="mb-1">Total Interest Collected</h6>
          <h4 class="text-warning fw-bold mb-0">₹{{ total_interest_collected|floatformat:2 }}</h4>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card shadow-sm p-3 border-start border-danger border-4 custom-card">
      <div class="d-flex align-items-center">
        <i class="fas fa-exclamation-triangle fa-2x text-danger me-3"></i>
        <div>
          <h6 class="mb-1">Total Outstanding Principal</h6>
          <h4 class="text-danger fw-bold mb-0">₹{{ total_outstanding|floatformat:2 }}</h4>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- Loan Table -->
<div class="table-responsive">
  <table class="table table-hover shadow-sm">
    <thead class="table-light">
      <tr>
        <th>Borrower</th>
        <th>Project / Purpose</th>
        <th>Loan Amount</th>
        <th>Interest Rate</th>
        <th>Start Date</th>
        <th>Total Interest Paid</th>
        <th>Remaining Balance</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for loan in loans %}
      <tr>
        <td><a href="#" class="text-primary" data-bs-toggle="modal" data-bs-target="#viewLoanModal{{ loan.id }}">{{ loan.project }}</a></td>
        <td>{{ loan.loan_purpose }}</td>
        <td>${{ loan.amount|floatformat:2 }}</td>
        <td>{{ loan.interest_rate|floatformat:2 }}%</td>
        <td>{{ loan.start_date }}</td>
        <td>${{ loan.total_interest_paid|default:"0.00"|floatformat:2 }}</td>
        <td>${{ loan.remaining_balance|default:"0.00"|floatformat:2 }}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editLoanModal{{ loan.id }}">
             <i class="bi bi-pencil-square"></i>
          </button>
          <a href="{% url 'loan_detail' loan.id %}" class="btn btn-sm btn-outline-success">
              <i class="bi bi-eye"></i>
          </a>
          <button class="btn btn-sm btn-outline-danger" onclick="deleteLoan({{ loan.id }})">
             <i class="bi bi-trash"></i>
          </button>
        </td>
      </tr>

      <!-- Edit Modal -->
      <div class="modal fade" id="editLoanModal{{ loan.id }}" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <form method="post" action="{% url 'update_loan' loan.id %}">
              {% csrf_token %}
              <div class="modal-header">
                <h5 class="modal-title">Edit Loan - {{ loan.loan_id }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                {{ loan.get_form.as_p }}
              </div>
              <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Save changes</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- View Modal -->
      <div class="modal fade" id="viewLoanModal{{ loan.id }}" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content p-3">
            <div class="modal-header">
              <h5 class="modal-title">Loan Details</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <p><strong>Borrower:</strong> {{ loan.project.borrower_name }}</p>
              <p><strong>Project:</strong> {{ loan.project.name }}</p>
              <p><strong>Loan Amount:</strong> ${{ loan.amount|floatformat:2 }}</p>
              <p><strong>Interest Rate:</strong> {{ loan.interest_rate|floatformat:2 }}%</p>
              <p><strong>Purpose:</strong> {{ loan.loan_purpose }}</p>
              <p><strong>Start Date:</strong> {{ loan.start_date }}</p>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Add Modal -->
<!-- Blue & White Styled Add Loan Modal -->
<div class="modal fade" id="addLoanModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="post" action="{% url 'create_loan' %}">
        {% csrf_token %}
        <div class="d-flex">
          <!-- Blue Side -->
          <div class="p-4 bg-primary text-white d-flex flex-column justify-content-between" style="width: 35%; border-top-left-radius: .5rem; border-bottom-left-radius: .5rem;">
            <div>
              <i class="fas fa-university fa-3x mb-3"></i>
              <h5 class="fw-bold">New Loan</h5>
              <p style="font-size: 14px;">Register a loan with full details</p>
            </div>
            <img src="https://i.pinimg.com/736x/f7/35/dd/f735ddc5552b0dd478ccd35b084b2dea.jpg" alt="Loan Icon" class="img-fluid mt-auto" style="max-height: 80px;">
          </div>

          <!-- White Form Side -->
          <div class="p-4 bg-white rounded-end w-100">
            <h5 class="mb-4 fw-bold text-primary">Loan Details</h5>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="id_loan_id" class="form-label">Loan ID</label>
                {{ form.loan_id }}
              </div>
              <div class="col-md-6 mb-3">
                <label for="id_project" class="form-label">Project</label>
                {{ form.project }}
              </div>
              <div class="col-md-6 mb-3">
                <label for="id_amount" class="form-label">Amount</label>
                {{ form.amount }}
              </div>
              <div class="col-md-6 mb-3">
                <label for="id_interest_rate" class="form-label">Interest Rate (%)</label>
                {{ form.interest_rate }}
              </div>
              <div class="col-md-6 mb-3">
                <label for="id_start_date" class="form-label">Start Date</label>
                {{ form.start_date }}
              </div>
              {% comment %} <div class="col-md-6 mb-3">
                <label for="id_repayment_date" class="form-label">Repayment Date</label>
                {{ form.repayment_date }}
              </div> {% endcomment %}
              <div class="col-12 mb-3">
                <label for="id_purpose" class="form-label">Loan Purpose</label>
                {{ form.loan_purpose }}
              </div>
            </div>

            <!-- Buttons -->
            <div class="d-flex justify-content-end gap-2 mt-3">
              <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary text-white">Add Loan</button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  function deleteLoan(id) {
    if (confirm('Are you sure you want to delete this loan?')) {
      fetch("{% url 'delete_loan' %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: `loan_id=${id}`
      }).then(response => response.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          alert('Error: ' + data.message);
        }
      });
    }
  }
</script>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function () {
    $('.live-filter').on('input change', function () {
      clearTimeout(window._filterDelay);
      window._filterDelay = setTimeout(function () {
        $('#loanFilterForm').submit();
      }, 300);
    });
  });
</script>

{% endblock %}